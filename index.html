<html>
    <head>
        <title>Studio Ghibli Directors</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-array.v2.min.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

        <style>
        html, body{
            height: 315%;
            padding: 10px;
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: beige; 
            text-shadow:2px 2px 4px #0000008f;
        }
        .bg{
            background-image: url("ghibli-background.png");
            height: 100%;
            background-repeat: no-repeat;
            background-size: cover;
            background-color: rgba(255, 255, 255, 0.3);
            background-blend-mode: overlay;
        }
        /* https://www.geeksforgeeks.org/css-floating-animation/ */

        .floating {  
            animation-name: floating;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            margin-left: 30px;
            margin-top: 5px;
        }
        @keyframes floating { 
            0% { transform: translate(0,  0px); }
            50%  { transform: translate(0, 15px); }
            100%   { transform: translate(0, -0px); }    
        }
        a{
            color: rgb(230, 163, 19);
            text-shadow:2px 2px 4px #0000008f;

        }
        </style>
    </head>

    <body class = "bg">
        <div style = "display: flex; align-items:center; flex-direction: column;">
            <h1> <i>My Neighbor Takahata:</i> A Studio Ghibli Director Analysis </h1>
            <!-- <img class="floating" src = "ponyo.png" width = 180 height = 180 style="margin-left: 1200; position: absolute" > </img> -->
            <p>by Carly Hu (ch862) and Myna Lim (ml2326)</p>
            <h3 style = "background-color: rgb(4, 88, 96);"> "I gave Isao Takahata 15 years of my youth. I want them back!" - Hayao Miyazaki</h3>
        </div>

       
        <div style = "display: flex; flex-direction: row;">
            <div style = "display: flex; flex-direction: column; width: 700px;">
                <div style = "display: flex; flex-direction: column">
                <div style = "width: 600px">
                <p style = "margin: 20px"> In the world of animation, few names are as revered as Hayao Miyazaki, 
                    the pioneering spirit behind <a href = "https://en.wikipedia.org/wiki/Studio_Ghibli">Studio Ghibli</a>. 
                    Somewhat less popular is that of Isao Takahata's: another Ghibli director who had a thriving partnership and eventual divergence from Miyazaki. 
                    In his 2018 biography, Toshio Suzuki (President of Studio Ghibli) provides a glimpse into the
                    complexities of this <a href = "http://takara-bako.com/index.php/2021/01/21/miyazaki-takahatas-work-relationship-and-how-it-ended/">relationship</a>.</p>
                    <p style = "margin: 20px">In this article, we will use <a href = "https://www.kaggle.com/datasets/shruthiiiee/studio-ghibli-dataset">data</a> to explore the differences
                    that characterized Miyazaki, Takahata, and other directors' contributions to Studio Ghibli, 
                    examining key details between their respective films. </p>
                </div>
                <img class="floating" src = "totoro.png" width = 8%  style="margin-left: 600; margin-top: 10; position: absolute" > </img>
                </div>  
                <svg class="timeline" id = "timeline" style="margin: 20px; height: 2000px; width: 700px; ">timeline</svg>

            </div>
                <div style = "display: flex; flex-direction: column; position: fixed; margin-left: 750;">
                    <div class = "select" style="margin: 20px; height: 120px; width: 600px; border: 2px solid white;"> select</div>
                    <svg class = "linechart" id = "linechart" style="margin: 20px; height: 350px; width: 600px; border: 2px solid white;"> visualization</svg>
                    <!-- https://github.com/edriessen/scrollytelling-scrollama-d3-demo?tab=readme-ov-file 
                    for scrolly library -->
                </div>
            </div>
    </body>

    <script>
        const requestData = async function(){
            const ghibliData = await d3.csv("studio-ghibli.csv");
            console.log(ghibliData);
            //string -> int
            ghibliData.forEach(d => {
                    d.Budget = +d.Budget.replace(/\D/g, ''); 
                    });
                ghibliData.forEach(d => {
                    d.Revenue = +d.Revenue.replace(/\D/g, ''); 
                    });
                ghibliData.forEach(d => {
                    d.Year = +d.Year.replace(/\D/g, ''); 
                    });
            ghibliData.sort((a, b) => a.Year - b.Year);

            const svg = d3.select("#timeline")
            let margin = { top: 50, bottom: 40, right: 35, left: 200 }
            const width = svg.attr("width");
            const height = svg.attr("height");
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            let annotations = svg.append("g").attr("id","annotations");

            // timeline top labels
            svg.append('rect')
                .attr('x', 53)
                .attr('y', 41)
                .attr('width', 245)
                .style("text-anchor", "middle")
                .attr('height', 25)
                .attr('fill', 'beige')
                .attr("opacity", 0.6)
                .attr("rx", "5")
            svg.append('text')
                .text("Isao Takahata / Others")
                .attr('x', 175)
                .attr('y', 60)
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .attr('font-size', '20px')
                .style('fill', "#3A5311")
                .style('text-shadow', 'none');
            svg.append('rect')
                .attr('x', 438)
                .attr('y', 41)
                .attr('width', 175)
                .style("text-anchor", "middle")
                .attr('height', 25)
                .attr('fill', 'beige')
                .attr("opacity", 0.6)
                .attr("rx", "5")
            svg.append('text')
                .text("Hayao Miyazaki")
                .attr('x', 175+350)
                .attr('y', 60)
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .attr('font-size', '20px')
                .style('fill', "#281E50")
                .style('text-shadow', 'none');
            
            // svg.append('rect')
            // .attr('x', 340)
            // .attr('y', 100)
            // .attr('width', 20)
            // .attr('height', 1800)
            // .attr('stroke', 'white')
            // .attr('fill', 'white')
            // .attr('opacity', 0.5);

            // create scale
            const yearExtent = d3.extent(ghibliData, d => d.Year);
            const yearScale = d3.scaleLinear()
                .domain(yearExtent)
                .range([100, 1900]);

            const directors = d3.map(ghibliData, d => d.Director)
            const directorScale = d3.scaleBand()
                .domain(directors)
                .range([chartWidth/2-chartWidth/4, chartWidth/2+chartWidth/4])
                .padding([0.2]);
            
            // draw timeline
            let leftAxis = d3.axisLeft(yearScale).tickFormat(d3.format(''));
            annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${margin.left+170},${0})`)
                    .style('text-shadow', 'none')
                    .style("font-size", "18px")
                    .style("font-family", "Georgia")
                    .style("stroke", "black")
                    .call(leftAxis)
                    .selectAll("line")
                    .style("fill", "black")
                    .style("stroke", "black"); // change tick line color
            annotations.select(".y.axis path").style("stroke", "black"); 
            annotations.selectAll(".y.axis text").style("fill", "black"); 

            annotations.raise();

            ghibliData.forEach( d => {
                        d.x = d.Director === "Hayao Miyazaki" ? 340+145 : 340-160;
                        d.y = yearScale(d.Year) ;
                    });

            // adding in data 
            let images = svg.selectAll("image").data(ghibliData)
                .join("image")
                .attr("xlink:href", "dust.png")
                .attr("width", 50)
                .attr("x", d => d.Director === "Hayao Miyazaki" ? 340+145 : 340-160)
                .attr("y", d => yearScale(d.Year)  );

            let labelback= svg.append("rect").attr("visibility","hidden")    
            let label = svg.append("text").attr("visibility","hidden")    

            // mouseover functionality
            images.on("mouseover", function() {
                d3.select(this).attr("opacity", 1);

                let name = d3.select(this).datum()["Name"]
                // let rank = "#" + Math.round(d3.select(this).datum()["rank"])
                //let ethnicity = d3.select(this).datum()["Ethnicity"]
                // let count = "("+d3.select(this).datum()["overall_count"]+")"

                let allInfo = name

                console.log(d3.select(this).datum().x)
                if (d3.select(this).datum().x > 200){
                    side = d3.select(this).datum().x + 60
                } else {
                    side = d3.select(this).datum().x - 160

                }
                let film = d3.select(this).datum()

                label.text(allInfo) 
                    .attr("x", side) 
                    .attr("y", (film.y + 0)) 
                    .attr("visibility", "visible")
                    .style("font-size", "12")
                    .style("font-weight", "bold")
                    .style("text-shadow", "none")
                    .style("font-style", "italic")

                label.append("tspan").text(film["Director"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter")
                label.append("tspan").text("Budget: "+film["Budget"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkred")
                label.append("tspan").text("Revenue: "+film["Revenue"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkgreen")
                label.append("tspan").text("Duration: "+film["Duration"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkblue")

                labelWidth = d3.select(this).datum()["Name"].length 

                labelback.style("fill","beige")
                    .attr("width", 160)
                    .attr("height", 160)
                    .attr("visibility","visible")
                    .attr("x", side - 10) 
                    .attr("y", (d3.select(this).datum().y - 20)) 
                    .style("stroke-width", "2")
                    .style("opacity", "0.6")
                    .style("rx", "5")
            });

            // const movies = d3.map(ghibliData, d => d.Name)
            // const moviesScale = d3.scaleBand()
            //                 .domain(movies)
            //                 .range([0, 10])
            //                 .padding([0.2])

                        // var yScale = d3.scaleBand()
                        //             .domain(breakdowns)
                        //             .range([10, breakHeight])
                        //             .padding([0.2])

                        
            // line plots!

            // const svg = d3.select("#timeline")
            // let margin = { top: 50, bottom: 40, right: 35, left: 200 }
            // const width = svg.attr("width");
            // const height = svg.attr("height");

            let lineplot = d3.select("#linechart")
            const annotations2 = lineplot.append("g").attr("id","annotations");
            const width2 = 600 // idk why it's not pulling when i do it normally
            const height2 = 350
            const margin2 = {top: 10, right: 10, bottom: 50, left: 50};
            const chartWidth2 = width2 - margin2.left - margin2.right;
            const chartHeight2 = height2 - margin2.top - margin2.bottom;
            

            let chartArea = lineplot.append("g").attr("transform","translate("+margin2.left+","+margin2.top+")");

            const loadLine = async function() {

                const xScale = d3.scaleLinear().domain(yearExtent).range([0, chartWidth2]);
                const budgetExtent = d3.extent(ghibliData, d => d.Budget);
                const yScale = d3.scaleLog().domain(budgetExtent).range([chartHeight2,0])

                let leftAxis2 = d3.axisLeft(yScale).tickFormat(d3.format("$.2s"))
                let leftGridlines2 = d3.axisLeft(yScale)
                        .tickSize(-chartWidth2-10)
                        .tickFormat("");

                annotations2.append('g')
                        .attr('transform',`translate(${margin2.left-10},${margin2.top})`) 
                        .call(leftAxis2)
                
                let bottomAxis = d3.axisBottom(xScale)
                annotations2.append('g')
                     .attr('transform',`translate(${margin2.left},${chartHeight2+margin2.top+10})`)
                     .call(bottomAxis)

                const miyazakiData = ghibliData.filter(d => d.Director === "Hayao Miyazaki");
                const othersData = ghibliData.filter(d => d.Director !== "Hayao Miyazaki");

                const lineGenerator1 = d3.line()
                    .x(d => xScale(d['Year']))
                    .y(d => yScale(d['Budget']));

                // Append the first line
                chartArea.append('path')
                    .datum(miyazakiData)
                    .attr('d', lineGenerator1)
                    .attr('fill', 'none')
                    .attr('stroke', 'darkblue')
                    .attr('stroke-width', 2);

                const lineGenerator2 = d3.line()
                    .x(d => xScale(d['Year']))
                    .y(d => yScale(d['Budget']));

                // Append the first line
                chartArea.append('path')
                    .datum(othersData)
                    .attr('d', lineGenerator2)
                    .attr('fill', 'none')
                    .attr('stroke', 'red')
                    .attr('stroke-width', 2);
            
                chartArea.selectAll("circle.point").data(ghibliData)
                    .join("circle").attr("class","point")
                    .attr("cx", d => xScale(d['Year']))
                    .attr("cy", d => yScale(d['Budget']))
                    .attr("r", 3)
                    .attr("opacity", 1)
                    .style("fill", d => d.Director === "Hayao Miyazaki" ? 'darkblue' : 'red');



        }
        loadLine();
    }
        requestData();

    </script>
</html>