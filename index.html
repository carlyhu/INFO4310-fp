<html>
    <head>
        <title>Studio Ghibli Directors</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-array.v2.min.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

        <style>
        html, body{
            height: 315%;
            padding: 10px;
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: beige; 
            text-shadow:2px 2px 4px #0000008f;
        }
        .bg{
            background-image: url("ghibli-background.png");
            height: 100%;
            background-repeat: no-repeat;
            background-size: cover;
            background-color: rgba(255, 255, 255, 0.3);
            background-blend-mode: overlay;
        }
        /* https://www.geeksforgeeks.org/css-floating-animation/ */

        .floating {  
            animation-name: floating;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            margin-left: 30px;
            margin-top: 5px;
        }
        @keyframes floating { 
            0% { transform: translate(0,  0px); }
            50%  { transform: translate(0, 15px); }
            100%   { transform: translate(0, -0px); }    
        }
        a{
            color: rgb(222, 152, 0);
            text-shadow:2px 2px 4px #0000008f;

        }
        .plotTypes{
            padding: 10px;
            margin-right: 20px;
            width: 150px;
            font-family: Georgia, 'Times New Roman', Times, serif;
            border-radius: 10px;
            background-color: beige;
            border: none;
        }
        @keyframes shake { 
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateY(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateY(5px);
            }
        }
        .shake {
            animation: shake 2s; 
            animation-iteration-count: infinite;
        }
        </style>
    </head>

    <body class = "bg">
        <div style = "display: flex; align-items:center; flex-direction: column;">
            <h1 style = "margin: 10px"> <i>My Neighbor Takahata:</i> A Studio Ghibli Director Analysis </h1>
            <!-- <img class="floating" src = "ponyo.png" width = 180 height = 180 style="margin-left: 1200; position: absolute" > </img> -->
            <p>by Carly Hu (ch862) and Myna Lim (ml2326)</p>
            <h2 style = "background-color: rgb(4, 88, 96);"> "I gave Isao Takahata 15 years of my youth. I want them back!" - Hayao Miyazaki</h2>
        </div>

       
        <div style = "display: flex; flex-direction: row;">
            <div style = "display: flex; flex-direction: column; width: 700px;">
                <div style = "display: flex; flex-direction: column">
                <div style = "width: 600px">
                <p style = "margin: 20px"> In the world of animation, few names are as revered as Hayao Miyazaki, 
                    the pioneering spirit behind <a href = "https://en.wikipedia.org/wiki/Studio_Ghibli">Studio Ghibli</a>. 
                    Somewhat less popular is that of Isao Takahata's: another Ghibli director who had a thriving partnership and eventual divergence from Miyazaki. 
                    In his 2018 biography, Toshio Suzuki (President of Studio Ghibli) provides a glimpse into the
                    complexities of this <a href = "http://takara-bako.com/index.php/2021/01/21/miyazaki-takahatas-work-relationship-and-how-it-ended/">relationship</a>.</p>
                    <p style = "margin: 20px">In this article, we will use <a href = "https://www.kaggle.com/datasets/shruthiiiee/studio-ghibli-dataset">data</a> to explore the differences
                    that characterized Miyazaki, Takahata, and other directors' contributions to Studio Ghibli, 
                    examining key details between their respective films. </p>
                </div>
                <img class="floating" src = "totoro.png" width = 8%  style="margin-left: 600; margin-top: 10; position: absolute" > </img>
                </div>  
                <svg class="timeline" id = "timeline" style="margin: 20px; height: 2000px; width: 700px; "></svg>

            </div>
                <div style = "display: flex; flex-direction: column; position: fixed; margin-left: 750;">
                    <div class = "select" id = "button-bar" style="margin: 20px; width: 600px; display: flex; justify-content: center; align-items: center;"> </div>
                    <svg class = "linechart" id = "linechart" style="margin: 20px; height: 450px; width: 600px; "> </svg>
                    <!-- https://github.com/edriessen/scrollytelling-scrollama-d3-demo?tab=readme-ov-file 
                    for scrolly library -->
                   
                </div>
            </div>
    </body>

    <script>
        const requestData = async function(){
            const ghibliData = await d3.csv("studio-ghibli.csv");
            console.log(ghibliData);

            // duration conversion
            function convertDuration(duration) {
                const regex = /(?:(\d+)h)?\s*(?:(\d+)m)?/;
                const match = duration.match(regex);
                const hours = parseInt(match[1]) || 0;  //  0 if no hours are found
                const minutes = parseInt(match[2]) || 0;  // 0 if no minutes are found
                return hours * 60 + minutes;
            }
            
            //string -> int
            ghibliData.forEach(d => {
                    d.Budget = +d.Budget.replace(/\D/g, ''); 
                    });
                ghibliData.forEach(d => {
                    d.Revenue = +d.Revenue.replace(/\D/g, ''); 
                    });
                ghibliData.forEach(d => {
                    d.Year = +d.Year.replace(/\D/g, ''); 
                    });
                ghibliData.forEach(d => {
                    d.Duration = convertDuration(d.Duration);
                })
            ghibliData.sort((a, b) => a.Year - b.Year);


            const svg = d3.select("#timeline")
            let margin = { top: 50, bottom: 40, right: 35, left: 200 }
            const width = svg.attr("width");
            const height = svg.attr("height");
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            let annotations = svg.append("g").attr("id","annotations");

            // timeline top labels
            svg.append('rect')
                .attr('x', 53)
                .attr('y', 41)
                .attr('width', 245)
                .style("text-anchor", "middle")
                .attr('height', 25)
                .attr('fill', 'beige')
                .attr("opacity", 0.6)
                .attr("rx", "5")
            svg.append('text')
                .text("Isao Takahata / Others")
                .attr('x', 175)
                .attr('y', 60)
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .attr('font-size', '20px')
                .style('fill', "rgb(222, 152, 0)")
                .style('text-shadow', 'none');
            svg.append('rect')
                .attr('x', 438)
                .attr('y', 41)
                .attr('width', 175)
                .style("text-anchor", "middle")
                .attr('height', 25)
                .attr('fill', 'beige')
                .attr("opacity", 0.6)
                .attr("rx", "5")
            svg.append('text')
                .text("Hayao Miyazaki")
                .attr('x', 175+350)
                .attr('y', 60)
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .attr('font-size', '20px')
                .style('fill', "rgb(4, 88, 96)")
                .style('text-shadow', 'none');

            // create scale
            const yearExtent = d3.extent(ghibliData, d => d.Year);
            const yearScale = d3.scaleLinear()
                .domain(yearExtent)
                .range([100, 1900]);

            const directors = d3.map(ghibliData, d => d.Director)
            const directorScale = d3.scaleBand()
                .domain(directors)
                .range([chartWidth/2-chartWidth/4, chartWidth/2+chartWidth/4])
                .padding([0.2]);
            
            // draw timeline
            let leftAxis = d3.axisLeft(yearScale).tickFormat(d3.format(''));
            annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${margin.left+170},${0})`)
                    .style('text-shadow', 'none')
                    .style("font-size", "18px")
                    .style("font-family", "Georgia")
                    .style("stroke", "black")
                    .call(leftAxis)
                    .selectAll("line")
                    .style("fill", "black")
                    .style("stroke", "black"); // change tick line color
            annotations.select(".y.axis path").style("stroke", "black"); 
            annotations.selectAll(".y.axis text").style("fill", "black"); 

            annotations.raise();

            ghibliData.forEach( d => {
                        d.x = d.Director === "Hayao Miyazaki" ? 340+145 : 340-160;
                        d.y = yearScale(d.Year) ;
                    });

            // adding in data 
            let images = svg.selectAll("image").data(ghibliData)
                .join("image")
                .attr("xlink:href", "dust.png")
                .attr("width", 50)
                .attr("x", d => d.Director === "Hayao Miyazaki" ? 340+145 : 340-160)
                .attr("y", d => yearScale(d.Year)  );

            let labelback= svg.append("rect").attr("visibility","hidden")    
            let label = svg.append("text").attr("visibility","hidden")    

            // hover functionality
            images.on("mouseover", function() {
                console.log(d3.select(this).attr("width"))
                d3.select(this).attr("width", 80) 
                              .attr("height",80)
                              .classed("shake", true);  
        
                let film = d3.select(this).datum()

                let name = film["Name"]
                let allInfo = name

                if (d3.select(this).datum().x > 200){
                    side = d3.select(this).datum().x + 60
                } else {
                    side = d3.select(this).datum().x - 160
                }

                label.text(allInfo) 
                    .attr("x", side) 
                    .attr("y", (film.y + 0)) 
                    .attr("visibility", "visible")
                    .style("font-size", "12")
                    .style("font-weight", "bold")
                    .style("text-shadow", "none")
                    .style("font-style", "italic")

                label.append("tspan").text(film["Director"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter")
                label.append("tspan").text("Budget: "+film["Budget"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkred")
                label.append("tspan").text("Revenue: "+film["Revenue"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkgreen")
                label.append("tspan").text("Duration: "+film["Duration"]).attr("x", side).attr("dy", "2em").style("font-weight", "lighter").style("font-style", "normal").style("fill", "darkblue")

                labelWidth = d3.select(this).datum()["Name"].length 

                labelback.style("fill","beige")
                    .attr("width", 200)
                    .attr("height", 130)
                    .attr("visibility","visible")
                    .attr("x", side - 10) 
                    .attr("y", (d3.select(this).datum().y - 20)) 
                    .style("stroke-width", "2")
                    .style("opacity", "0.6")
                    .style("rx", "5")

                // affect line graph during hover
                let correspondingCircle = chartArea.selectAll("circle.point").filter(d => d.Name === film.Name);
                correspondingCircle.transition().duration(200)
                    .attr("r", 10) 
                    .attr("stroke", "beige")
                    .attr("stroke-width", 2);

            });

            images.on("mouseout", function() {

                d3.select(this).attr("width", 50)
                d3.select(this).attr("height", 50)


                let film = d3.select(this).datum();
                let correspondingCircle = chartArea.selectAll("circle.point").filter(d => d.Name === film.Name);
                correspondingCircle.transition().duration(200)
                    .attr("r", 3) 
                    .attr("stroke", "none");
                
                d3.select(this).attr("width", 50) 
                            .attr("height",50)
                            .classed("shake", false);  
            });
                        
            // line plots!
            let lineplot = d3.select("#linechart")
            const annotations2 = lineplot.append("g").attr("id","annotations");
            const width2 = 600 
            const height2 = 450
            const margin2 = {top: 10, right: 10, bottom: 50, left: 50};
            const chartWidth2 = width2 - margin2.left - margin2.right;
            const chartHeight2 = height2 - margin2.top - margin2.bottom;
            
            let chartArea = lineplot.append("g").attr("transform","translate("+margin2.left+","+margin2.top+")");

            let yAxis = annotations2.append('g')
                        .attr('transform',`translate(${margin2.left-10},${margin2.top})`)
            let xAxis = annotations2.append('g')
                     .attr('transform',`translate(${margin2.left},${chartHeight2+margin2.top+10})`) 

            function loadLine(plotType) {

                type = plotType
                const xScale = d3.scaleLinear().domain(yearExtent).range([0, chartWidth2]);
                const extent = d3.extent(ghibliData, d => d[plotType]);

                let yScale = d3.scaleLog().domain(extent).range([chartHeight2,0])
                if (type ==="Duration"){
                    yScale = d3.scaleLinear().domain(extent).range([chartHeight2,0])
                }

                let leftAxis2 = d3.axisLeft(yScale).tickFormat(d3.format(".2s"))
                let leftGridlines2 = d3.axisLeft(yScale)
                        .tickSize(-chartWidth2-10)
                        .tickFormat("");
                
                yAxis.call(leftAxis2)
                .selectAll('path,line').style('stroke', 'black');
                yAxis.selectAll('text').style('fill', 'black').style("text-shadow", "none");

                let bottomAxis = d3.axisBottom(xScale).tickFormat(d3.format(".0f"));
                xAxis.call(bottomAxis)
                .selectAll('path,line').style('stroke', 'black');
                xAxis.selectAll('text').style('fill', 'black').style("text-shadow", "none");

                const miyazakiData = ghibliData.filter(d => d.Director === "Hayao Miyazaki");
                const othersData = ghibliData.filter(d => d.Director !== "Hayao Miyazaki");

                const lineGenerator= d3.line()
                    .x(d => xScale(d['Year']))
                    .y(d => yScale(d[plotType]))
                    .curve(d3.curveCatmullRom);  
              
            // miyazaki line
            chartArea.selectAll('path.miyazaki-line')
                    .data([miyazakiData])  
                    .join(
                        enter => enter.append('path')
                            .attr('class', 'miyazaki-line')
                            .attr('fill', 'none')
                            .attr('stroke', 'rgb(4, 88, 96)')
                            .attr('stroke-width', 2)
                            .attr('d', lineGenerator),
                        update => update
                            .transition()  
                            .duration(500)
                            .attr('d', lineGenerator),
                        exit => exit.remove()
                    );
            // takahata line 
            chartArea.selectAll('path.others-line')
                .data([othersData]) 
                .join(
                    enter => enter.append('path')
                        .attr('class', 'others-line')
                        .attr('fill', 'none')
                        .attr('stroke', 'rgb(230, 163, 19)')
                        .attr('stroke-width', 2)
                        .attr('d', lineGenerator),
                    update => update
                        .transition()  
                        .duration(500)
                        .attr('d', lineGenerator),
                    exit => exit.remove()
        );
            // adding circles
                chartArea.selectAll("circle.point")
                    .data(ghibliData)
                    .join(
                        enter => enter.append("circle")
                        .attr("class","point")
                    .attr("cx", d => xScale(d['Year']))
                    .attr("cy", d => yScale( d[plotType]))
                    .attr("r", 3)
                    .attr("opacity", 1)
                    .style("fill", d => d.Director === "Hayao Miyazaki" ? 'rgb(4, 88, 96)' : 'rgb(230, 163, 19)'),
                    update => update
                        .transition()  
                        .duration(500)
                        .attr("cx", d => xScale(d['Year'])) 
                      .attr("cy", d => yScale(d[plotType])) ,
                    exit => exit.remove()
                    )
            }
        // button bar
        const plotTypes = ["Budget", "Revenue", "Duration"]
          plotTypes.forEach(d => {

            d3.select("div#button-bar")
              .append("button")
              .attr("id", `${d}`)
              .attr("class", "plotTypes")
              .text(d)
              .on("click", function () {
                d3.selectAll("button.plotTypes").style('background-color', "beige").style("text-decoration", "none");
                d3.select(this).style("background-color", "rgb(230, 163, 19)")
                plotType = d;
                loadLine(d);
            })
        })
            d3.select(`button#Budget`)  // Use the ID to select the button
            .style('background-color', "rgb(230, 163, 19)")
            .style("text-decoration", "underline");
        loadLine("Budget");
    }
        requestData();

    </script>
</html>